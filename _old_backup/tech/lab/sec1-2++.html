---
layout: page
title: "Section 1: Build Android and Inside Dalvik"
---
<!--
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>Sec 1: Build Android and Inside Dalvik</TITLE>
<META http-equiv=Content-Type content="text/html; charset=gb2312"><LINK 
href="labs.css" 
type=text/css rel=stylesheet>
-->
<body>
<h2>Part 2: INSIDE DALVIK OPCODE</h2>

<p>
What Dalvik opcode to the Dalvik VM is what x86 instructions to Intel CPU.
It is the basic ISA(Instruction Set Architecture) of the virtual machine.
</p>

<h3>Different between Dalvik and Traditional JVM</h3>
<p>
See the two opcode tables below to find out the difference between the traditional stack-based JVM implementation and Dalvik.
<br>
References: <a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html"> Dalvik Opcode Table</a> 
and <a href="http://en.wikipedia.org/wiki/Java_bytecode_instruction_listings"> Java Opcode Table</a>
<br>
More about Java Bytecode <a href="http://www.ibm.com/developerworks/ibm/library/it-haggar_bytecode/">HERE</a>
</p>
<p>
Feel free to answer the question below:
<pre>
     Question1: Why do dalvik use register based design? (Hint, think about the opcode number and the memory for the same program.)
</pre>
</p>

<h3>Understanding Dalvik Opcodes</h3>
<p>
We choose simplecounter.apk as an example for you to get familiar with the Dalvik opcodes.
Simplecounter.apk is a very very simple App which will count from 0 too 100 and show its result on screen.
All you should do in this task is to double its result by doubling its steps.
You can download it <a href="Simplecounter.apk" >here</a>.
Follow the steps below:
<ol>
<li> <b>unzip the apk package</b><br>
 In this step, you can utilize some other integrated tools, such as <a href="http://code.google.com/p/android-apktool/">apktools</a>. However, it is highly recommended to unpack and pack the .apk file yourself for a deeper understanding of its construction and layout. Use the comments below to unpack an apk package:
<pre>
$ mv simplecounter.apk simplecounter.zip; unzip simplecounter.zip
</pre>
After doing this, you will get the structure of apk, in which classes.dex is our target. 
<p>
Dex(.dex) file is a classes file very resemble to class(.class) file in java. 
In fact, Dex files are just transfered from the class files which are generated by java compiler. 
However, there are also many differences between them. 
In short, dex file is a compressed class file which contains all the classes in a certain App.
It has better performance and less size in mobile devices.
Their brief differences are shown <a href="http://www.slideshare.net/Bhavsidd/diff-of-class-and-dex-file">here</a>. 
For more information, you can reference the dex layout <a href="http://source.android.com/tech/dalvik/dex-format.html">here</a> and java <a href="http://docs.oracle.com/javase/specs/jls/se7/html/index.html">here</a>. 
</p>
<p>
Backing to the file classes.dex, it is the compiled java code which is in the delvik format. 
The goal of this exercise is to let you know what Dalvik opcode looks like and how it works.
</p>
</li>
<li>
<b>Disassemble the classes.dex</b><br>
Classes.dex is in the binary formate which is not human readable.
What we should do next is to disassemble it.
There are several schemes and tools for this particular purpose.
Smali/baksmali is what we recommended.<br>
Because:
<ul>
   <li>They are really fast</li>
   <li>You can assemble the modified code into the package</li>
</ul>

You can get smali/baksmali script from its <a href="http://code.google.com/p/smali/">offical pages</a>.
After you download them, run the following command:
<pre>
$ ./baksmali -b -o src/ classes.dex
</pre>
<p>
Now, you will get the jasmin like code in the .smali files under folder src/.
</p>
</li>

<li>
<b>Read the code</b>
<p>
In order to modify code in smali format, you should be pretty familiar with the Dalvik opcodes and smali format.
Here are some introductions:
</p>
<ul>
<li>smali introduction:<br>
	<a href="http://code.google.com/p/smali/wiki/Registers">Registers</a><br>
	<a href="http://code.google.com/p/smali/wiki/TypesMethodsAndFields">Types&Methods&Fields</a>
</li>
<li>Delvik opcodes:<br>
	<a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">delvik opcodes</a>
</li>
</ul>
<p>
In the program simplecounter, there will be a counter which count from 0 to 100 and display it on the screen.
All you should do is double its step from 1 to 2 which will lead to a result of 200 on screen.
Its java code is listed below. Compare it with the smali code to discover whether you are aware of Dalvik opcodes.
</p>
<pre>
public class SimpleCounter {
	
	public static int count(){
		int count = 0;
		for(int i=0;i<100;i++){
			count++;
		}
		return count;
	}

}
</pre>
</li>

<li>
<b>Hack the code</b>
<p>
<i>Use your own way to double the step.</i>
</p>

<li>
<b>Recreate the apk package</b>
<p>
In this step, you should assemble the code by using smali script.
</p>
<pre>
$ ./smali -o classes.dex src/
</pre>
<p>
Then replace the original classes.dex using new classes.dex.
</p>
<pre>
$ cp classes.dex /path/to/unzip-folder/
</pre>
<p>
The next step is rm the previous signiture in META-INF folder.
</p>
<pre>
$ rm -r META-INF
</pre>
<p>
At last, use zip to create .apk file including the modified code.
</p>
<pre>
$ zip -r newsimplecounter.apk *
</pre>
<p>
Finally, you get a new .apk file newsimplecounter.apk.
</p>
</li>

<li>
<b>Sign the apk</b>
<p>
In this step, you should generate your own keystore.
</p>
<pre>
$ keytool -genkey -alias my.keystore -keyalg RSA -validity 20000 -keystore my.keystore 
</pre>
<p>
After answer some questions, you will get a file called my.keystore.
With the generated key, you have the ability to sign the apk in your own.
</p>
<pre>
$ jarsigner -verbose -keystore my.keystore -signedjar simplecounter_sign.apk newsimplecounter.apk my.keystore
</pre>
<p>
At last, you get the simplecounter_sign.apk which is an installable apk.
</p>
<p>
Run your emulator and install it by using:
</p>
<pre>
$ adb install -r simplecounter_sign.apk
</pre>
<p>
Click the icon on your emulator, if it shows you 200, then <i>congratulations</i>!:)
</p>
</li>
</ol>
</p>

</body>
